<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.90.0/dist/supabase.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    h1 { text-align: center; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    #habit-dashboard div { margin-bottom: 15px; }
    textarea { width: 100%; height: 50px; }
  </style>
</head>
<body>
  <h1>Habit Tracker</h1>
  <div id="auth-container"></div>
  <div id="habit-dashboard"></div>

  <script>
    // ---------------------
    // 1️⃣ Supabase setup
    // ---------------------
    const SUPABASE_URL = "https://drnkoftzavraufyjwjvx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_secret_QCnsOinMqa6pdqOTJrCCAA_XMhKqGBl";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------------------
    // 2️⃣ Handle OAuth redirect
    // ---------------------
    async function handleRedirect() {
      try {
        const { data, error } = await supabaseClient.auth.getSessionFromUrl({ storeSession: true });
        if (error) console.error("Error handling redirect:", error.message);
        else if (data.session) console.log("Redirect session captured:", data.session);

        // remove hash from URL for cleanliness
        if (window.location.hash) {
          history.replaceState(null, null, window.location.pathname);
        }
      } catch (err) {
        console.error(err);
      }
    }

    // ---------------------
    // 3️⃣ Auth functions
    // ---------------------
    async function signInWithGoogle() {
      const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
      if (error) alert(error.message);
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.location.reload();
    }

    // ---------------------
    // 4️⃣ Render login / dashboard
    // ---------------------
    async function renderApp() {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      const session = sessionData.session;

      const authContainer = document.getElementById('auth-container');
      const habitContainer = document.getElementById('habit-dashboard');

      if (!session) {
        authContainer.innerHTML = `<button onclick="signInWithGoogle()">Sign in with Google</button>`;
        habitContainer.innerHTML = '';
        return;
      }

      authContainer.innerHTML = `
        <p>Welcome, ${session.user.email}</p>
        <button onclick="signOut()">Sign Out</button>
      `;

      renderDummyHabits();
    }

    // ---------------------
    // 5️⃣ Dummy habits for testing
    // ---------------------
    function renderDummyHabits() {
      const container = document.getElementById('habit-dashboard');
      container.innerHTML = '';

      const dummyHabits = [
        { id: 1, name: "Exercise", category: "Fitness", has_text_input: true },
        { id: 2, name: "Read", category: "Learning", has_text_input: true },
        { id: 3, name: "Meditate", category: "Mindfulness", has_text_input: false },
      ];

      dummyHabits.forEach(habit => {
        const div = document.createElement('div');
        div.innerHTML = `
          <strong>${habit.name} (${habit.category})</strong><br/>
          Completed: <input type="checkbox" id="habit-${habit.id}" />
          ${habit.has_text_input ? '<br/><textarea placeholder="Add reflection..."></textarea>' : ''}
          <br/>Share with group? <input type="checkbox" />
          <hr/>
        `;
        container.appendChild(div);
      });
    }

    // ---------------------
    // 6️⃣ On load
    // ---------------------
    handleRedirect().then(() => renderApp());

    // Listen to auth changes (sign out from another tab, etc.)
    supabaseClient.auth.onAuthStateChange(() => renderApp());

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Habit Tracker</title>

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.8/dayjs.min.js"></script>

<style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 20px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.tabs button {
  margin-right: 8px;
}

.actions button {
  margin-left: 8px;
}

.tab {
  display: none;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  width: 320px;
  border-radius: 10px;
}

input, select {
  width: 100%;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="tabs">
    <button onclick="showTab('dashboard')">Dashboard</button>
    <button onclick="showTab('progress')">Habit Progress</button>
    <button onclick="showTab('goals')">Goals</button>
    <button onclick="showTab('activity')">Activity</button>
  </div>

  <div class="actions" id="auth-actions"></div>
</div>

<div id="dashboard" class="tab"></div>
<div id="progress" class="tab"></div>
<div id="goals" class="tab"></div>
<div id="activity" class="tab"></div>

<!-- PROFILE MODAL -->
<div id="profile-modal" class="modal">
  <div class="modal-content">
    <h3>Complete Profile</h3>
    <input id="first-name" placeholder="First Name" />
    <input id="last-name" placeholder="Last Name" />
    <input id="height" type="number" placeholder="Height" />
    <input id="weight" type="number" placeholder="Weight" />
    <button onclick="saveProfile()">Save</button>
  </div>
</div>

<!-- GOAL MODAL -->
<div id="goal-modal" class="modal">
  <div class="modal-content">
    <h3>New Goal</h3>
    <input id="goal-name" placeholder="Goal name" />
    <input id="goal-category" placeholder="Category (e.g. Fitness)" />
    <input id="goal-subtype" placeholder="Subtype (e.g. Running)" />
    <select id="goal-cadence">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
    </select>
    <button onclick="saveGoal()">Save Goal</button>
  </div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://drnkoftzavraufyjwjvx.supabase.co",
  "sb_publishable_3ZM5ByDTEwo3GS8KCbNHtw_zi6ewd6b"
);

let currentUser = null;

/* ---------------- Tabs ---------------- */
function showTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

/* ---------------- Auth ---------------- */
async function initAuth() {
  const { data } = await supabaseClient.auth.getSession();
  currentUser = data.session?.user || null;

  const actions = document.getElementById('auth-actions');

  if (!currentUser) {
    actions.innerHTML = `<button onclick="signIn()">Sign In</button>`;
    return;
  }

  actions.innerHTML = `
    <button onclick="openGoalModal()">+ Add Goal</button>
    <button onclick="signOut()">Sign Out</button>
  `;

  await checkProfile();
  loadDashboard();
  loadGoals();
  loadProgress();
}

async function signIn() {
  await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
}

async function signOut() {
  await supabaseClient.auth.signOut();
  location.reload();
}

/* ---------------- Profile ---------------- */
async function checkProfile() {
  const { data } = await supabaseClient
    .from('userprofile')
    .select('*')
    .eq('user_id', currentUser.id)
    .single();

  if (!data) {
    document.getElementById('profile-modal').style.display = 'flex';
  }
}

async function saveProfile() {
  await supabaseClient.from('userprofile').insert([{
    user_id: currentUser.id,
    first_name: firstName.value,
    last_name: lastName.value,
    height: height.value,
    weight: weight.value
  }]);

  document.getElementById('profile-modal').style.display = 'none';
}

/* ---------------- Goals ---------------- */
function openGoalModal() {
  document.getElementById('goal-modal').style.display = 'flex';
}

async function saveGoal() {
  await supabaseClient.from('habits').insert([{
    user_id: currentUser.id,
    name: goalName.value,
    category: goalCategory.value,
    subtype: goalSubtype.value,
    cadence: goalCadence.value,
    active: true
  }]);

  document.getElementById('goal-modal').style.display = 'none';
  loadDashboard();
  loadGoals();
}

async function deleteGoal(id) {
  await supabaseClient.from('habits').delete().eq('id', id);
  loadDashboard();
  loadGoals();
}

/* ---------------- Dashboard ---------------- */
async function loadDashboard() {
  showTab('dashboard');

  const { data } = await supabaseClient
    .from('habits')
    .select('*')
    .eq('user_id', currentUser.id)
    .eq('active', true);

  dashboard.innerHTML = `<h2>Dashboard</h2>` +
    data.map(h => `
      <div>
        <strong>${h.name}</strong>
        <div>${h.category} 路 ${h.subtype} 路 ${h.cadence}</div>
      </div><hr/>
    `).join('');
}

/* ---------------- Goals Tab ---------------- */
async function loadGoals() {
  const { data } = await supabaseClient
    .from('habits')
    .select('*')
    .eq('user_id', currentUser.id);

  goals.innerHTML = `<h2>Goals</h2>` +
    data.map(g => `
      <div>
        <strong>${g.name}</strong>
        <div>${g.category} 路 ${g.subtype} 路 ${g.cadence}</div>
        <button onclick="deleteGoal('${g.id}')">Delete</button>
      </div><hr/>
    `).join('');
}

/* ---------------- Progress ---------------- */
async function loadProgress() {
  progress.innerHTML = `
    <h2>Habit Progress</h2>
    <p>Weekly and Monthly aggregation will live here.</p>
  `;
}

/* ---------------- Activity ---------------- */
activity.innerHTML = `<h2>Activity</h2><p>Social feed coming soon.</p>`;

supabaseClient.auth.onAuthStateChange(initAuth);
initAuth();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Habit Tracker</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.8/dayjs.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { text-align: center; }
    nav button { margin-right: 10px; }
    .habit-container { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    .progress-container { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    .progress-bar { background: #eee; width: 200px; height: 20px; position: relative; }
    .progress-bar-fill { background: green; height: 100%; }
    .progress-text { min-width: 60px; text-align: right; }
    textarea { width: 300px; height: 40px; }
    .activity-log { margin-top: 20px; border-top: 2px solid #444; padding-top: 10px; }
    .activity-entry { margin-bottom: 10px; padding: 5px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>Habit Tracker</h1>
  <div id="auth-container"></div>
  <nav>
    <button onclick="showTab('dashboard')">Dashboard</button>
    <button onclick="showTab('activity')">Activity</button>
  </nav>
  <div id="dashboard-tab"></div>
  <div id="activity-tab" style="display:none;"></div>

  <script>
    // -------------------------
    // Supabase setup
    // -------------------------
    const SUPABASE_URL = "https://drnkoftzavraufyjwjvx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_3ZM5ByDTEwo3GS8KCbNHtw_zi6ewd6b";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const today = dayjs().format("YYYY-MM-DD");

    // -------------------------
    // Dummy Data
    // -------------------------
    let dummyHabits = [
      { id:1, name:'Read', category:'Personal', subtype:'Book', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:1 },
          { goal_type:'weekly', goal_value:3, completed:2 },
        ]
      },
      { id:2, name:'Meditate', category:'Wellness', subtype:'Mindfulness', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:1 },
          { goal_type:'monthly', goal_value:20, completed:12 },
        ]
      },
      { id:3, name:'Run', category:'Fitness', subtype:'Cardio', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:0 },
          { goal_type:'weekly', goal_value:3, completed:1 },
        ]
      },
      { id:4, name:'Lift', category:'Fitness', subtype:'Strength', has_text_input:true, goals:[
          { goal_type:'weekly', goal_value:2, completed:1 },
          { goal_type:'monthly', goal_value:8, completed:4 },
        ]
      },
      { id:5, name:'Yoga', category:'Fitness', subtype:'Stretch', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:1 },
          { goal_type:'monthly', goal_value:12, completed:5 },
        ]
      },
      { id:6, name:'Learn JS', category:'Skill', subtype:'Programming', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:0 },
          { goal_type:'monthly', goal_value:15, completed:5 },
        ]
      }
    ];

    // -------------------------
    // Auth (Google only)
    // -------------------------
    async function signInWithGoogle() {
      const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
      if(error) alert(error.message);
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.location.reload();
    }

    async function renderApp() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      const authContainer = document.getElementById('auth-container');
      if(!session){
        authContainer.innerHTML = `<button onclick="signInWithGoogle()">Sign in with Google</button>`;
        document.getElementById('dashboard-tab').innerHTML = '';
        document.getElementById('activity-tab').innerHTML = '';
        return;
      }
      authContainer.innerHTML = `
        <p>Welcome, ${session.user.email} <button onclick="signOut()">Sign Out</button></p>
      `;
      renderDashboard();
      renderActivity();
    }

    // -------------------------
    // Tab switching
    // -------------------------
    function showTab(tab){
      document.getElementById('dashboard-tab').style.display = (tab==='dashboard') ? 'block' : 'none';
      document.getElementById('activity-tab').style.display = (tab==='activity') ? 'block' : 'none';
    }

    // -------------------------
    // Dashboard
    // -------------------------
    function renderDashboard(){
      const container = document.getElementById('dashboard-tab');
      container.innerHTML = '';
      dummyHabits.forEach(habit => {
        const habitDiv = document.createElement('div');
        habitDiv.className = 'habit-container';
        habitDiv.innerHTML = `<h3>${habit.name} (${habit.category} / ${habit.subtype})</h3>`;
        habit.goals.forEach(goal => {
          const pct = Math.min((goal.completed/goal.goal_value)*100, 100).toFixed(1);
          const progressHTML = `
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-bar-fill" style="width:${pct}%"></div>
              </div>
              <div class="progress-text">${goal.completed}/${goal.goal_value} (${pct}%)</div>
            </div>
          `;
          habitDiv.innerHTML += progressHTML;
        });
        // Reflection + Post button
        habitDiv.innerHTML += `
          ${habit.has_text_input ? '<textarea placeholder="Add reflection..."></textarea><br/>' : ''}
          <button onclick="postReflection('${habit.name}')">Post</button>
        `;
        container.appendChild(habitDiv);
      });
    }

    // -------------------------
    // Activity Tab
    // -------------------------
    let dummyActivity = [];
    function renderActivity(){
      const container = document.getElementById('activity-tab');
      container.innerHTML = '<h3>Activity Feed</h3>';
      if(dummyActivity.length===0){
        container.innerHTML += '<p>No activity yet.</p>';
      } else {
        dummyActivity.forEach(entry => {
          const div = document.createElement('div');
          div.className = 'activity-entry';
          div.innerHTML = `<strong>${entry.habit}</strong>: ${entry.reflection}`;
          container.appendChild(div);
        });
      }
    }

    function postReflection(habitName){
      const habitDivs = document.querySelectorAll('.habit-container');
      habitDivs.forEach(div=>{
        if(div.querySelector('h3').textContent.startsWith(habitName)){
          const textarea = div.querySelector('textarea');
          if(textarea && textarea.value.trim()!==''){
            dummyActivity.push({ habit: habitName, reflection: textarea.value.trim() });
            textarea.value = '';
            renderActivity();
            showTab('activity');
          }
        }
      });
    }

    // -------------------------
    // Init
    // -------------------------
    supabaseClient.auth.onAuthStateChange(()=>renderApp());
    renderApp();

  </script>
</body>
</html>

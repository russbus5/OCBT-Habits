<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Habit Tracker</title>

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px; }
nav button { margin-right:10px; }
.habit-row {
  display:grid;
  grid-template-columns:120px 1fr 280px;
  gap:15px;
  padding:10px 0;
  border-bottom:1px solid #ddd;
}
.progress-bar { height:14px; background:#eee; width:100%; }
.progress-fill { height:100%; background:#4caf50; }
.goal-label { font-size:12px; }
.week-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
.month-grid { display:grid; grid-template-columns:repeat(10,1fr); gap:5px; }
.box { height:20px; background:#ddd; }
.box.filled { background:#4caf50; }
.hidden { display:none; }
.activity-entry { border-bottom:1px solid #ddd; padding:8px 0; }
</style>
</head>

<body>
<h1>Habit Tracker</h1>

<div id="auth"></div>

<nav>
  <button onclick="showTab('dashboard')">Dashboard</button>
  <button onclick="showTab('weekly')">Weekly Activity</button>
  <button onclick="showTab('monthly')">Monthly Activity</button>
  <button onclick="showTab('activity')">Activity</button>
  <button onclick="showTab('settings')">Settings</button>
</nav>

<div id="dashboard"></div>
<div id="weekly" class="hidden"></div>
<div id="monthly" class="hidden"></div>
<div id="activity" class="hidden"></div>
<div id="settings" class="hidden"></div>

<script>
/* ---------------- SUPABASE AUTH ONLY ---------------- */
const supabaseClient = supabase.createClient(
  "https://drnkoftzavraufyjwjvx.supabase.co",
  "sb_publishable_3ZM5ByDTEwo3GS8KCbNHtw_zi6ewd6b"
);

/* ---------------- HELPERS ---------------- */
function percent(c,t){ return ((c/t)*100); }
function visual(p){ return Math.min(p,100); }
function showTab(tab){
  ["dashboard","weekly","monthly","activity","settings"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(tab).classList.remove("hidden");
}

/* ---------------- FAKE USERS ---------------- */
const users = ["Russ Lee","Jamie Chen","Alex Morgan"];

/* ---------------- FAKE ACTIVITY ---------------- */
let activityLog = [
  { name:"Jamie Chen", activity:"Completed Read", reflection:"Focused session", date:"2024-12-01" },
  { name:"Alex Morgan", activity:"Completed Run", reflection:"Cold but solid", date:"2024-12-02" },
  { name:"Russ Lee", activity:"Completed Read", reflection:"Learned a lot", date:"2024-12-03" }
];

/* ---------------- HABITS ---------------- */
const habits = [
  {
    name:"Read",
    goals:[
      {type:"daily", target:3, completed:4},
      {type:"weekly", target:5, completed:3},
      {type:"monthly", target:12, completed:14}
    ]
  },
  {
    name:"Run",
    goals:[
      {type:"daily", target:1, completed:1},
      {type:"weekly", target:2, completed:3},
      {type:"monthly", target:8, completed:6}
    ]
  }
];

/* ---------------- DASHBOARD ---------------- */
function renderDashboard(){
  const el = document.getElementById("dashboard");
  el.innerHTML = "<h2>Dashboard</h2>";

  habits.forEach(h=>{
    h.goals.filter(g=>g.type==="daily").forEach(g=>{
      const p = percent(g.completed,g.target);
      el.innerHTML += `
      <div class="habit-row">
        <div>
          <input type="checkbox" onchange="toggle('${h.name}')">
          <div>${h.name}</div>
          <div class="goal-label">Daily</div>
        </div>
        <div>
          <textarea id="ref-${h.name}" placeholder="Reflection..."></textarea><br/>
          <button onclick="post('${h.name}')">Post</button>
        </div>
        <div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${visual(p)}%"></div>
          </div>
          <div>${p.toFixed(1)}%</div>
        </div>
      </div>`;
    });
  });
}

function toggle(name){
  const h = habits.find(x=>x.name===name);
  h.goals.find(g=>g.type==="daily").completed++;
  renderDashboard();
}

/* ---------------- POST TO ACTIVITY ---------------- */
function post(habit){
  const text = document.getElementById(`ref-${habit}`).value;
  activityLog.unshift({
    name:"Russ Lee",
    activity:`Completed ${habit}`,
    reflection:text,
    date:new Date().toISOString().split("T")[0]
  });
  renderActivity();
}

/* ---------------- WEEKLY ---------------- */
function renderWeekly(){
  const el = document.getElementById("weekly");
  el.innerHTML = "<h2>Weekly Activity</h2>";
  habits.forEach(h=>{
    h.goals.filter(g=>g.type==="weekly").forEach(g=>{
      const p = percent(g.completed,g.target);
      el.innerHTML += `
      <h4>${h.name}</h4>
      <div class="week-grid">
        ${Array.from({length:7}).map((_,i)=>`<div class="box ${i<g.completed?'filled':''}"></div>`).join("")}
      </div>
      <div>${p.toFixed(1)}%</div>`;
    });
  });
}

/* ---------------- MONTHLY ---------------- */
function renderMonthly(){
  const el = document.getElementById("monthly");
  el.innerHTML = "<h2>Monthly Activity</h2>";
  habits.forEach(h=>{
    h.goals.filter(g=>g.type==="monthly").forEach(g=>{
      const p = percent(g.completed,g.target);
      el.innerHTML += `
      <h4>${h.name}</h4>
      <div class="month-grid">
        ${Array.from({length:30}).map((_,i)=>`<div class="box ${i<g.completed?'filled':''}"></div>`).join("")}
      </div>
      <div>${p.toFixed(1)}%</div>`;
    });
  });
}

/* ---------------- ACTIVITY ---------------- */
function renderActivity(){
  const el = document.getElementById("activity");
  el.innerHTML = "<h2>Activity Log</h2>";
  activityLog.forEach(a=>{
    el.innerHTML += `
      <div class="activity-entry">
        <strong>${a.name}</strong> â€” ${a.activity}<br/>
        <em>${a.reflection}</em><br/>
        <small>${a.date}</small>
      </div>`;
  });
}

/* ---------------- SETTINGS ---------------- */
function renderSettings(){
  document.getElementById("settings").innerHTML = `
    <h2>Settings</h2>
    <button onclick="logout()">Log out</button>
  `;
}

/* ---------------- AUTH ---------------- */
async function login(){
  await supabaseClient.auth.signInWithOAuth({provider:"google"});
}
async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

supabaseClient.auth.onAuthStateChange((_e,session)=>{
  const auth = document.getElementById("auth");
  if(!session){
    auth.innerHTML = `<button onclick="login()">Sign in with Google</button>`;
  } else {
    auth.innerHTML = `<p>Signed in as ${session.user.email}</p>`;
    renderDashboard();
    renderWeekly();
    renderMonthly();
    renderActivity();
    renderSettings();
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Habit Tracker</title>

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
body { font-family: Arial; padding:20px; }
nav button { margin-right:8px; }
.habit-row {
  display:grid;
  grid-template-columns:120px 1fr 260px;
  gap:12px;
  border-bottom:1px solid #ddd;
  padding:10px 0;
}
.progress-bar { background:#eee; height:14px; }
.progress-fill { background:#4caf50; height:100%; }
.hidden { display:none; }
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.4);
  display:flex; align-items:center; justify-content:center;
}
.modal-content {
  background:white; padding:20px; width:300px;
}
.calendar {
  display:grid; grid-template-columns:repeat(7,1fr); gap:4px;
}
.day { height:30px; background:#eee; }
.day.filled { background:#4caf50; }
</style>
</head>

<body>

<h1>
  Habit Tracker
  <button style="float:right" onclick="openGoalModal()">ï¼‹</button>
</h1>

<div id="auth"></div>

<nav>
  <button onclick="show('dashboard')">Dashboard</button>
  <button onclick="show('progress')">Progress</button>
  <button onclick="show('activity')">Activity</button>
  <button onclick="show('settings')">Settings</button>
</nav>

<div id="dashboard"></div>
<div id="progress" class="hidden"></div>
<div id="activity" class="hidden"></div>
<div id="settings" class="hidden"></div>

<!-- Goal Modal -->
<div id="goalModal" class="modal hidden">
  <div class="modal-content">
    <h3>Create Goal</h3>
    <input id="g-name" placeholder="Habit name"><br><br>
    <select id="g-category">
      <option>Exercise</option><option>Read</option><option>Learn</option>
    </select><br><br>
    <input id="g-subtype" placeholder="Subtype (Run, Lift...)"><br><br>
    <select id="g-type">
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select><br><br>
    <input id="g-target" type="number" placeholder="Target"><br><br>
    <button onclick="createGoal()">Save</button>
    <button onclick="closeGoalModal()">Cancel</button>
  </div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://drnkoftzavraufyjwjvx.supabase.co",
  "sb_publishable_3ZM5ByDTEwo3GS8KCbNHtw_zi6ewd6b"
);

let user;

function show(id){
  ["dashboard","progress","activity","settings"].forEach(x=>{
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

function openGoalModal(){ document.getElementById("goalModal").classList.remove("hidden"); }
function closeGoalModal(){ document.getElementById("goalModal").classList.add("hidden"); }

async function createGoal(){
  await supabaseClient.from("habits").insert({
    user_id:user.id,
    name: g-name.value,
    category: g-category.value,
    subtype: g-subtype.value,
    goal_type: g-type.value,
    target: Number(g-target.value)
  });
  closeGoalModal();
  loadDashboard();
}

async function loadDashboard(){
  const today = new Date().toISOString().slice(0,10);

  const { data: habits } = await supabaseClient
    .from("habits").select("*").eq("user_id", user.id);

  const { data: logs } = await supabaseClient
    .from("habit_logs").select("*").eq("user_id", user.id);

  dashboard.innerHTML = "<h2>Daily</h2>";

  habits.forEach(h=>{
    const weekCount = logs.filter(l=>l.habit_id===h.id).length;
    const pct = (weekCount/h.target)*100;
    const doneToday = logs.some(l=>l.habit_id===h.id && l.date===today);

    dashboard.innerHTML += `
      <div class="habit-row">
        <div>
          <input type="checkbox" ${doneToday?"checked disabled":""}
            onchange="complete('${h.id}')">
          ${h.name}
        </div>
        <textarea id="ref-${h.id}" placeholder="Reflection"></textarea>
        <div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${Math.min(pct,100)}%"></div>
          </div>
          ${weekCount}/${h.target} (${pct.toFixed(1)}%)
          <br><button onclick="post('${h.id}')">Post</button>
        </div>
      </div>`;
  });
}

async function complete(id){
  await supabaseClient.from("habit_logs").insert({
    user_id:user.id,
    habit_id:id,
    date:new Date().toISOString().slice(0,10)
  });
  loadDashboard();
}

async function post(id){
  const text = document.getElementById("ref-"+id).value;
  await supabaseClient.from("activity").insert({
    user_id:user.id,
    habit_id:id,
    reflection:text
  });
  alert("Posted to Activity");
}

async function loadActivity(){
  const { data } = await supabaseClient
    .from("activity")
    .select("reflection,created_at,habits(name)")
    .order("created_at",{ascending:false});

  activity.innerHTML = "<h2>Activity</h2>";
  data.forEach(a=>{
    activity.innerHTML += `
      <div>
        <strong>${a.habits.name}</strong><br>
        ${a.reflection}<br>
        <small>${a.created_at}</small>
      </div>`;
  });
}

async function loadSettings(){
  settings.innerHTML = `<button onclick="logout()">Log out</button>`;
}

async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

supabaseClient.auth.onAuthStateChange(async (_,session)=>{
  if(!session){
    auth.innerHTML = `<button onclick="supabaseClient.auth.signInWithOAuth({provider:'google'})">Sign in</button>`;
  } else {
    user = session.user;
    auth.innerHTML = `Signed in as ${user.email}`;
    loadDashboard();
    loadActivity();
    loadSettings();
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Habit Tracker</title>

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
body { font-family: Arial; margin: 0; padding: 0; background:#f5f5f5; }
header { padding:12px; background:#222; color:white; display:flex; justify-content:space-between; align-items:center; }
button { cursor:pointer; }
.hidden { display:none; }

.tabs button { margin-right:10px; }

.container { padding:20px; }

.habit-row {
  display:grid;
  grid-template-columns: 80px 1fr 200px;
  gap:12px;
  align-items:center;
  margin-bottom:10px;
  background:white;
  padding:10px;
}

.progress-bar {
  height:10px;
  background:#ddd;
  border-radius:6px;
  overflow:hidden;
}

.progress-bar > div {
  height:100%;
  background:#4caf50;
}

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  align-items:center;
  justify-content:center;
}

.modal-content {
  background:white;
  padding:20px;
  width:300px;
}
</style>
</head>

<body>

<header class="hidden" id="appHeader">
  <div>Habit Tracker</div>
  <div>
    <button onclick="openGoalModal()">＋</button>
    <button onclick="switchTab('dashboard')">Dashboard</button>
    <button onclick="switchTab('activity')">Activity</button>
    <button onclick="switchTab('settings')">Settings</button>
  </div>
</header>

<div class="container">

  <!-- AUTH -->
  <div id="auth">
    <button onclick="signIn()">Sign in with Google</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden"></div>

  <!-- ACTIVITY -->
  <div id="activity" class="hidden"></div>

  <!-- SETTINGS -->
  <div id="settings" class="hidden">
    <button onclick="logout()">Log Out</button>
  </div>
</div>

<!-- CREATE GOAL MODAL -->
<div id="goalModal" class="modal hidden">
  <div class="modal-content">
    <h3>Create Goal</h3>

    <input id="g-name" placeholder="Goal name"><br><br>

    <select id="g-category">
      <option>Exercise</option>
      <option>Reading</option>
      <option>Learning</option>
    </select><br><br>

    <input id="g-subtype" placeholder="Subtype"><br><br>

    <select id="g-type">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select><br><br>

    <input id="g-target" type="number" placeholder="Target"><br><br>
    <input id="g-units" placeholder="Units (times, miles, pages)"><br><br>

    <button onclick="createGoal()">Save</button>
    <button onclick="closeGoalModal()">Cancel</button>
  </div>
</div>

<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let user = null;

/* ---------------- AUTH ---------------- */

async function signIn(){
  await supabaseClient.auth.signInWithOAuth({ provider:'google' });
}

async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

supabaseClient.auth.onAuthStateChange(async (_, session)=>{
  if (!session) return;
  user = session.user;
  document.getElementById("auth").classList.add("hidden");
  document.getElementById("appHeader").classList.remove("hidden");
  switchTab("dashboard");
});

/* ---------------- TABS ---------------- */

function switchTab(tab){
  ["dashboard","activity","settings"].forEach(t =>
    document.getElementById(t).classList.add("hidden")
  );
  document.getElementById(tab).classList.remove("hidden");

  if (tab === "dashboard") loadDashboard();
  if (tab === "activity") loadActivity();
}

/* ---------------- GOALS ---------------- */

function openGoalModal(){
  document.getElementById("goalModal").classList.remove("hidden");
}

function closeGoalModal(){
  document.getElementById("goalModal").classList.add("hidden");
  ["g-name","g-subtype","g-target","g-units"].forEach(id => document.getElementById(id).value="");
}

async function createGoal(){
  await supabaseClient.from("habits").insert({
    user_id:user.id,
    name:g("g-name"),
    category:g("g-category"),
    subtype:g("g-subtype"),
    goal_type:g("g-type"),
    target:Number(g("g-target")),
    units:g("g-units")
  });
  closeGoalModal();
  loadDashboard();
}

/* ---------------- DASHBOARD ---------------- */

async function loadDashboard(){
  const { data: habits } = await supabaseClient
    .from("habits")
    .select("*")
    .eq("user_id", user.id);

  const { data: logs } = await supabaseClient
    .from("habit_logs")
    .select("*")
    .eq("user_id", user.id);

  const dash = document.getElementById("dashboard");
  dash.innerHTML = "";

  habits.forEach(h => {
    const total = logs
      .filter(l => l.habit_id === h.id)
      .reduce((a,b)=>a+b.amount,0);

    const pct = (total / h.target) * 100;

    dash.innerHTML += `
      <div class="habit-row">
        <div>
          <input type="checkbox" onclick="completeHabit('${h.id}')" />
        </div>
        <div>
          <strong>${h.name}</strong><br>
          ${h.goal_type} goal
        </div>
        <div>
          ${total}/${h.target} ${h.units}
          <div class="progress-bar">
            <div style="width:${Math.min(pct,200)}%"></div>
          </div>
          ${pct.toFixed(1)}%
        </div>
      </div>
    `;
  });
}

async function completeHabit(habitId){
  const today = new Date().toISOString().slice(0,10);

  const { data: existing } = await supabaseClient
    .from("habit_logs")
    .select("*")
    .eq("habit_id", habitId)
    .eq("log_date", today)
    .maybeSingle();

  if (existing) return alert("Already completed today");

  await supabaseClient.from("habit_logs").insert({
    habit_id:habitId,
    user_id:user.id,
    log_date:today,
    amount:1
  });

  alert("Posted to Activity");
  loadDashboard();
}

/* ---------------- ACTIVITY ---------------- */

async function loadActivity(){
  const { data } = await supabaseClient
    .from("habit_logs")
    .select("*, habits(name)")
    .order("created_at",{ascending:false});

  const a = document.getElementById("activity");
  a.innerHTML = "";

  data.forEach(l=>{
    a.innerHTML += `
      <div>
        <strong>${l.habits.name}</strong> — ${l.amount}
        <br><small>${new Date(l.created_at).toLocaleString()}</small>
        <hr>
      </div>
    `;
  });
}

/* ---------------- HELPERS ---------------- */
function g(id){ return document.getElementById(id).value; }
</script>

</body>
</html>

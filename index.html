<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Habit Tracker</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.8/dayjs.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { text-align: center; }
    nav button { margin-right: 10px; }
    .habit-container { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; display:flex; justify-content: space-between; }
    .habit-left { flex: 1; }
    .habit-right { flex: 1; padding-left: 20px; }
    .progress-container { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
    .progress-bar { background: #eee; width: 120px; height: 15px; position: relative; }
    .progress-bar-fill { background: green; height: 100%; }
    .progress-text { min-width: 50px; text-align: right; font-size: 12px; }
    textarea { width: 300px; height: 40px; }
    .activity-log { margin-top: 20px; border-top: 2px solid #444; padding-top: 10px; }
    .activity-entry { margin-bottom: 10px; padding: 5px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>Habit Tracker</h1>
  <div id="auth-container"></div>
  <nav>
    <button onclick="showTab('dashboard')">Dashboard</button>
    <button onclick="showTab('activity')">Activity</button>
  </nav>
  <div id="dashboard-tab"></div>
  <div id="activity-tab" style="display:none;"></div>

  <script>
    const SUPABASE_URL = "https://drnkoftzavraufyjwjvx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_3ZM5ByDTEwo3GS8KCbNHtw_zi6ewd6b";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const today = dayjs().format("YYYY-MM-DD");

    // -------------------------
    // Dummy habits
    // -------------------------
    let dummyHabits = [
      { id:1, name:'Read', category:'Personal', subtype:'Book', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:1 },
          { goal_type:'weekly', goal_value:3, completed:2 },
          { goal_type:'monthly', goal_value:12, completed:5 },
        ]
      },
      { id:2, name:'Run', category:'Fitness', subtype:'Cardio', has_text_input:true, goals:[
          { goal_type:'daily', goal_value:1, completed:0 },
          { goal_type:'weekly', goal_value:3, completed:1 },
          { goal_type:'monthly', goal_value:12, completed:4 },
        ]
      },
      { id:3, name:'Lift', category:'Fitness', subtype:'Strength', has_text_input:true, goals:[
          { goal_type:'weekly', goal_value:2, completed:1 },
          { goal_type:'monthly', goal_value:8, completed:4 },
        ]
      }
    ];

    let dummyActivity = [];

    // -------------------------
    // Auth
    // -------------------------
    async function signInWithGoogle() {
      const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
      if(error) alert(error.message);
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.location.reload();
    }

    async function renderApp() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      const authContainer = document.getElementById('auth-container');
      if(!session){
        authContainer.innerHTML = `<button onclick="signInWithGoogle()">Sign in with Google</button>`;
        document.getElementById('dashboard-tab').innerHTML = '';
        document.getElementById('activity-tab').innerHTML = '';
        return;
      }
      authContainer.innerHTML = `
        <p>Welcome, ${session.user.email} <button onclick="signOut()">Sign Out</button></p>
      `;
      renderDashboard(session.user.email);
      renderActivity();
    }

    function showTab(tab){
      document.getElementById('dashboard-tab').style.display = (tab==='dashboard') ? 'block' : 'none';
      document.getElementById('activity-tab').style.display = (tab==='activity') ? 'block' : 'none';
    }

    // -------------------------
    // Dashboard
    // -------------------------
    function renderDashboard(userEmail){
      const container = document.getElementById('dashboard-tab');
      container.innerHTML = '';
      dummyHabits.forEach(habit => {
        const habitDiv = document.createElement('div');
        habitDiv.className = 'habit-container';

        habitDiv.innerHTML = `
          <div class="habit-left">
            <h3>${habit.name} (${habit.category} / ${habit.subtype})</h3>
            <label><input type="checkbox" /> Completed</label><br/>
            ${habit.has_text_input ? '<textarea placeholder="Add reflection..."></textarea><br/>' : ''}
            <button onclick="postReflection('${habit.name}','${userEmail}', this)">Post</button>
          </div>
          <div class="habit-right">
            ${habit.goals.map(goal=>{
              const pct = Math.min((goal.completed/goal.goal_value)*100,100).toFixed(1);
              return `
              <div class="progress-container">
                <div class="progress-bar">
                  <div class="progress-bar-fill" style="width:${pct}%"></div>
                </div>
                <div class="progress-text">${goal.completed}/${goal.goal_value} (${pct}%)</div>
              </div>
              `;
            }).join('')}
          </div>
        `;
        container.appendChild(habitDiv);
      });
    }

    // -------------------------
    // Activity
    // -------------------------
    function renderActivity(){
      const container = document.getElementById('activity-tab');
      container.innerHTML = '<h3>Activity Feed</h3>';
      if(dummyActivity.length===0){
        container.innerHTML += '<p>No activity yet.</p>';
      } else {
        dummyActivity.forEach(entry=>{
          const div = document.createElement('div');
          div.className = 'activity-entry';
          div.innerHTML = `<strong>${entry.user}</strong> posted <strong>${entry.habit}</strong>: ${entry.reflection}`;
          container.appendChild(div);
        });
      }
    }

    function postReflection(habitName, userEmail, btn){
      const habitDiv = btn.closest('.habit-left');
      const textarea = habitDiv.querySelector('textarea');
      if(textarea && textarea.value.trim()!==''){
        dummyActivity.push({ habit: habitName, reflection: textarea.value.trim(), user:userEmail });
        textarea.value = '';
        renderActivity();
        showTab('activity');
      }
    }

    // -------------------------
    // Init
    // -------------------------
    supabaseClient.auth.onAuthStateChange(()=>renderApp());
    renderApp();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.8/dayjs.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 300px; height: 50px; }
    hr { margin: 10px 0; }
    .modal-bg {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: flex; justify-content: center; align-items: center;
    }
    .modal { background: white; padding: 20px; border-radius: 8px; min-width: 300px; }
    .tabs button { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Habit Tracker</h1>
  <div id="auth-container"></div>
  <div class="tabs">
    <button onclick="switchTab('dashboard')">Dashboard</button>
    <button onclick="switchTab('activity')">Activity</button>
    <button onclick="switchTab('settings')">Settings</button>
  </div>
  <div id="tab-content"></div>

  <!-- Profile modal container -->
  <div id="modal-container"></div>

  <script>
    // ---------------------
    // 1️⃣ Supabase setup
    // ---------------------
    const SUPABASE_URL = "https://drnkoftzavraufyjwjvx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_3ZM5ByDTEwo3GS8KCbNHtw_zi6ewd6b";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentProfile = null;
    let currentTab = 'dashboard';
    const today = dayjs().format("YYYY-MM-DD");

    // ---------------------
    // 2️⃣ Auth functions
    // ---------------------
    async function signInWithGoogle() {
      const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
      if (error) alert(error.message);
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.location.reload();
    }

    // ---------------------
    // 3️⃣ Tab switcher
    // ---------------------
    function switchTab(tab) {
      currentTab = tab;
      renderTab();
    }

    function renderTab() {
      const container = document.getElementById('tab-content');
      container.innerHTML = '';

      if (!currentUser) return;

      if (currentTab === 'dashboard') {
        renderDashboard();
      } else if (currentTab === 'activity') {
        renderActivity();
      } else if (currentTab === 'settings') {
        container.innerHTML = `
          <button onclick="signOut()">Log Out</button>
          <button onclick="showProfileModal(currentUser)">Edit Profile</button>
        `;
      }
    }

    // ---------------------
    // 4️⃣ Render app
    // ---------------------
    async function renderApp() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      const authContainer = document.getElementById('auth-container');

      if (!session) {
        authContainer.innerHTML = `<button onclick="signInWithGoogle()">Sign in with Google</button>`;
        document.getElementById('tab-content').innerHTML = '';
        return;
      }

      currentUser = session.user;
      authContainer.innerHTML = `<p>Welcome, ${currentUser.email}</p>`;

      await checkAndPromptProfile(currentUser);
      renderTab();
    }

    // ---------------------
    // 5️⃣ Profile modal
    // ---------------------
    async function checkAndPromptProfile(user) {
      try {
        const { data: profile, error } = await supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (error && error.code !== 'PGRST116') throw error;

        if (!profile || !profile.first_name) {
          showProfileModal(user);
        } else {
          currentProfile = profile;
        }
      } catch (err) {
        console.error('Error checking profile:', err.message);
      }
    }

    function showProfileModal(user) {
      const container = document.getElementById('modal-container');
      container.innerHTML = `
        <div class="modal-bg">
          <div class="modal">
            <h3>Set up your profile</h3>
            <input id="first-name" placeholder="First Name"/><br/>
            <input id="last-name" placeholder="Last Name"/><br/>
            <button id="save-profile-btn">Save</button>
          </div>
        </div>
      `;

      document.getElementById('save-profile-btn').onclick = async () => {
        const firstName = document.getElementById('first-name').value.trim();
        const lastName = document.getElementById('last-name').value.trim();
        if (!firstName || !lastName) {
          alert('Please enter both first and last name.');
          return;
        }

        try {
          const { data, error } = await supabaseClient
            .from('profiles')
            .upsert([{ id: user.id, first_name: firstName, last_name: lastName }], { onConflict: 'id' });
          if (error) throw error;

          currentProfile = { first_name: firstName, last_name: lastName };
          container.innerHTML = '';
          renderTab();
        } catch (err) {
          console.error('Error saving profile:', err.message);
          alert('Failed to save profile.');
        }
      };
    }

    // ---------------------
    // 6️⃣ Render dashboard
    // ---------------------
    async function renderDashboard() {
      const container = document.getElementById('tab-content');
      container.innerHTML = '';

      // Fetch habits for user
      const { data: habits } = await supabaseClient
        .from('habits')
        .select('*')
        .eq('user_id', currentUser.id);

      if (!habits) return;

      habits.forEach(habit => {
        const div = document.createElement('div');
        div.innerHTML = `
          <strong>${habit.name}</strong> (${habit.category}) [${habit.goal_type}]<br/>
          <input type="checkbox" id="habit-${habit.id}"/> Reflection: <textarea></textarea>
          <button class="post-btn">Post</button>
          <div class="progress-bar" style="width:200px;height:15px;background:#eee;margin-top:5px;"></div>
          <hr/>
        `;
        container.appendChild(div);

        const checkbox = div.querySelector(`#habit-${habit.id}`);
        const textarea = div.querySelector('textarea');
        const postBtn = div.querySelector('.post-btn');
        const progress = div.querySelector('.progress-bar');

        checkbox.addEventListener('change', async () => {
          const completed = checkbox.checked;
          await supabaseClient.from('habit_logs').upsert([{
            user_id: currentUser.id,
            habit_id: habit.id,
            date: today,
            completed: completed,
            reflection_text: textarea.value
          }]);
          // update progress visually
          progress.style.width = (completed ? 100 : 0) + 'px';
        });

        postBtn.addEventListener('click', () => {
          alert(`Posted "${habit.name}" activity!`);
        });
      });
    }

    // ---------------------
    // 7️⃣ Render activity
    // ---------------------
    async function renderActivity() {
      const container = document.getElementById('tab-content');
      container.innerHTML = '<h3>Activity Log</h3>';

      const { data: logs } = await supabaseClient
        .from('habit_logs')
        .select(`
          habit_id,
          completed,
          reflection_text,
          created_at,
          user_id,
          habits(name)
        `)
        .order('created_at', { ascending: false });

      if (!logs) return;

      logs.forEach(log => {
        const div = document.createElement('div');
        div.innerHTML = `
          <strong>${log.user_id}</strong> - ${log.habits?.name || 'Habit'} 
          | Reflection: ${log.reflection_text || ''}
          | Completed: ${log.completed}
          | ${dayjs(log.created_at).format('YYYY-MM-DD')}
          <hr/>
        `;
        container.appendChild(div);
      });
    }

    // ---------------------
    // 8️⃣ Initial load + auth listener
    // ---------------------
    supabaseClient.auth.onAuthStateChange(() => renderApp());
    renderApp();

  </script>
</body>
</html>
